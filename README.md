# GeweChatTask 定时任务插件

基于gewe和dify-on-wechat的定时任务插件，自定义扩展各类功能的集成基座

v1.0.0

### 版本兼容性
- croniter >= 1.3.0
- requests >= 2.28.0
- Python >= 3.7

## 功能特点
- 支持多种时间格式：每天、工作日、每周、今明后天、指定日期、Cron表达式
- 支持私聊和群聊创建任务
- 支持指定用户、群组创建提醒或任务
- 支持老黄历和星座运势查询（自动检查API余额）
- 支持API余额查询和自动提醒功能（可配置阈值）
- 解决了DOW中plugins框架重载如#scanp或#reloadp导致的并发问题
- 支持任务列表查看、删除全部任务（密码保护）
- 使用 SQLite 持久化存储任务数据
- 支持任务执行状态追踪和失败重试机制
- 内置数据库连接池，提高并发性能
- 支持配置文件热更新
- 智能的任务时间冲突处理
- 完善的错误处理和日志记录机制

## 使用方法

### 1. 提醒功能
直接发送提醒内容，格式：`提醒 + 内容`
提醒为前缀，发送前会去除该格式

#### 喝水提醒（每30分钟）
$time cron[*/30 * * * *] 提醒喝水了，该补充水分了

#### 休息提醒（每2小时）
$time cron[0 */2 * * 1-5] 提醒久坐伤身，起来走动一下

#### 吃饭提醒（每天）
$time 每天 12:00 提醒该吃午饭了
$time 每天 18:00 提醒晚饭时间到了

### 2. 插件功能

#### 插件调用方式
支持两种调用方式：
1. 定时任务方式：
```bash
$time 每天 08:00 p[老黄历]  # 每天早上查看老黄历
$time 每天 09:30 g[测试群] p[星座-白羊座]  # 每天早上给测试群推送白羊座运势
$time 工作日 09:30 u[张三] p[余额查询]  # 工作日给张三推送API余额信息
```

2. 直接调用方式（立即执行）：
```bash
$time p[老黄历]  # 立即查看今日老黄历
$time p[星座-巨蟹座]  # 立即查看巨蟹座运势
$time p[余额查询]  # 立即查询API余额
```

#### 老黄历
每天查看老黄历运势，包含宜忌、财神方位等信息
```bash
# 定时任务
$time 每天 08:00 p[老黄历]  # 每天早上查看老黄历
$time 每天 09:30 g[测试群] p[老黄历]  # 每天早上给测试群推送老黄历
$time 工作日 09:30 u[张三] p[老黄历]  # 工作日给张三推送老黄历

# 直接查看
$time p[老黄历]  # 立即查看今日老黄历
```

#### 星座运势
每天查看星座运势，包含运势评分、爱情、事业、财运等信息
```bash
# 定时任务
$time 每天 08:00 p[星座-巨蟹座]  # 每天早上查看巨蟹座运势
$time 每天 09:30 g[测试群] p[星座-白羊座]  # 每天早上给测试群推送白羊座运势
$time 工作日 09:30 u[张三] p[星座-天秤座]  # 工作日给张三推送天秤座运势

# 直接查看
$time p[星座-巨蟹座]  # 立即查看巨蟹座运势
```

支持的星座：
- 白羊座、金牛座、双子座、巨蟹座
- 狮子座、处女座、天秤座、天蝎座
- 射手座、魔羯座、水瓶座、双鱼座

#### API余额查询和自动提醒
（需要配置管理员昵称、API余额阈值，当触发插件时会自动检查并推送管理员）
- 自动监控API调用次数
- 当余额低于设定阈值时自动通知管理员
- 支持包年会员识别
```bash
# 定时任务
$time 今天 10:00 p[余额查询]  # 查询当前API余额
$time 每周一 09:00 u[张三] p[余额查询]  # 每周一给张三推送API余额信息

# 直接查看
$time p[余额查询]  # 立即查询API余额
```

### 3. 消息转发
不带"提醒"前缀的内容会被直接转发给对应的插件处理

#### 使用总结插件，获取最近5小时的新闻
$time 每天 08:00 总结 -5h

#### 使用画图插件，生成早安图片
$time 每天 09:00 画一个早安图片

#### 使用天气插件，获取天气信息
$time 每天 07:30 上海天气

#### 直接发送消息
$time 每天 09:00 早安，新的一天开始了
$time 工作日 18:00 下班愉快

### 4. 私聊创建群任务
#### 在私聊中创建群任务，使用g[群名]格式
$time 每天 09:30 g[测试群]早安打卡
$time 今天 00:15 g[测试群2]画图 flux &早安
$time 今天 23:58 g[测试群2]早报

### 5. 创建指定用户任务
#### 使用u[指定用户]格式
$time 今天 00:30 u[小助理] 画图 flux &晚安
$time 今天 00:16 u[菜菜] 提醒该睡觉啦
$time 每天 08:30 u[菜菜] 早报

### 6. 任务管理
#### 查看任务列表（需要密码）
$time 任务列表 你的密码

#### 取消任务
支持以下几种方式：
- 取消指定任务：`$time 取消 任务ID`（支持多个任务ID，可用逗号、空格、顿号分隔，如：`TYZE,XL52` 或 `TYZE、XL52`）
- 取消用户任务：`$time 取消 u[用户名]`（删除指定用户的所有任务）
- 取消群聊任务：`$time 取消 g[群名]`（删除指定群的所有任务）
- 取消所有任务：`$time 取消 all 密码`（删除所有任务，需要提供管理员密码）

示例：
```bash
# 取消单个任务
$time 取消 TYZE

# 取消多个任务
$time 取消 TYZE,XL52
$time 取消 TYZE、XL52
$time 取消 TYZE XL52

# 取消用户任务
$time 取消 u[菜菜]

# 取消群任务
$time 取消 g[测试群]

# 取消所有任务
$time 取消 all 密码
```

## Cron表达式说明
格式：`分 时 日 月 周`
- 分钟：0-59
- 小时：0-23
- 日期：1-31
- 月份：1-12
- 星期：0-7（0和7都表示周日）

特殊字符：
- `*`：表示任意值
- `,`：表示多个值，如 `1,3,5`
- `-`：表示范围，如 `1-5`
- `/`：表示间隔，如 `*/5`

常用示例：
- `0 9 * * 1-5`：工作日早上9点
- `*/30 * * * *`：每30分钟
- `0 */2 * * *`：每2小时
- `0 12 * * *`：每天中午12点

## 配置说明
在插件目录下创建 `config.json`：
```json
{
    "task_list_password": "你的密码",  // 查看任务列表的密码
    "yuanfenju_api_key": "你的API密钥",  // 缘分居API密钥，用于老黄历和星座运势功能（[API_KEY](https://portal.yuanfenju.com/Merchant/Public/register?yf=22943)）
    "admin_nickname": "管理员昵称",  // 管理员昵称，用于接收API余额不足提醒
    "balance_threshold": 20,  // API余额低于此阈值时发送提醒，默认为20
    "task_capacity": 100,  // 最大任务容量，默认为100
    "time_adjust_interval": 1  // 任务时间冲突时的调整间隔（分钟），默认为1
}
```

## 注意事项
1. 时间格式必须是24小时制，如 `09:30`、`18:00`
2. 查看任务列表，删除全部任务需要配置密码
3. 取消任务需要任务ID，可以从任务列表中查看
4. 在私聊中创建群任务时，需要确保机器人在目标群中，且机器人有保存该群聊到通讯录
5. 使用老黄历和星座运势功能需要配置缘分居API密钥
6. 建议配置管理员昵称和余额阈值，以便及时接收API余额不足提醒
7. 任务执行失败会自动重试，最多重试3次
8. 支持配置文件热更新，修改配置后无需重启插件
9. 一次性任务（今天、明天、后天、指定日期）会在执行完成后自动清理
10. 系统会自动处理任务时间冲突，根据配置的时间间隔自动调整执行时间
